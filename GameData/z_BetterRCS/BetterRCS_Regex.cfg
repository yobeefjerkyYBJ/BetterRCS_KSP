@PART[*]:HAS[@MODULE[ModuleRCSFX]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
    {
	@MODULE[ModuleRCSFX]
		{
		+atmosphereCurve 
			{
				|. = var_CurveISP
				@key,* ^= :\s+: :
				@key,*[0, ] -= 0.1
				@key,*[0, ] ^= :^[^\d\.].*:1701.9: // Vacuum ISP confirmed
			}	
			
		@var_CurveISP:HAS[#key[*1701.9*]]
			{
				@key,*[0, ] -= 0.8
				@key,*[0, ] ^= :^[^\d\.].*:696969: // Evil ISP
			}
			
		@var_CurveISP:HAS[#key[*1701.1*]]
			{
				@key,*[0, ] -= 0.2
				@key,*[0, ] ^= :^[^\d\.].*:4421: // Sea Level ISP confirmed
			}
			+var_CurveISP
				{
					|. = var_CurveISP_VacParse
				}
			+var_CurveISP
				{
					|. = var_CurveISP_SLParse
				}
			
		@var_CurveISP_VacParse:HAS[#key[*1700.9*]]
			{
				@key,* ^= :1700\.9 ::
				@key,*[0, ] -= 245
				@key,* ^= :^[^\d\.].\S*\s*$:Vac_LowPressure: // If the Vacuum ISP is below 245, VacLP
			}
			
		@var_CurveISP_SLParse:HAS[#key[*4421*]]
			{
				@key,* ^= :4421 ::
				@key,*[0, ] -= 80
				@key,* ^= :^[^\d\.].\S*\s*$:SL_LowPressure: // If the Sea Level ISP is below 80, SLLP
			}
			
		}
	}
	
@PART[*]:HAS[@MODULE[ModuleWaterfallFX],@MODULE[ModuleRCSFX]:HAS[@var_CurveISP]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
	{
		@MODULE[ModuleRCSFX]
		{
			|. = ModuleRCSFX
		}
		
		@MODULE[ModuleWaterfallFX]
		{
			
			!CONTROLLER,* {}
			CONTROLLER
			{
				name = atmosphereDepth
				linkedTo = atmosphere_density
			}
			CONTROLLER
			{
				name = rcs
				linkedTo = rcs
				thrusterTransformName = #$../../ModuleRCSFX/thrusterTransformName$
			}
			@TEMPLATE
			{
				scaleX = #$scale$
				@scaleX ^= :,.*$::
				@scale[1,,] = #$scaleX$
				!scaleX = dummy
			}
		}
		
		@ModuleRCSFX
		{
			|. = MODULE
		}
	}
	
//We are checking against the four cases provided by the earlier regex tomfoolery
//Namely, Base, Low Vacuum Pressure, Low Sea Level Pressure, and Low Universal Pressure
//These are modeled as follows:
//Base - Generic RCS Thruster
//Low Vacuum Pressure - Monopropellant RCS Thruster (This is a Low Vacuum ISP Thruster)
//Low Sea Level Pressure - Bipropellant RCS Thruster (This is a Low Sea Level ISP Thruster)
//Low Universal Pressure - Cold Gas Thruster (This is a low performance thruster with bad ISP at sea level and in vacuum)
	
@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@var_CurveISP_VacParse:HAS[~key[Vac_LowPressure]]&@var_CurveISP_SLParse:HAS[~key[SL_LowPressure]]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
	{
		@MODULE[ModuleWaterfallFX],*
		{
			@TEMPLATE
			{
				@templateName = BetterRCS_Base
			}
		}
	}
	
@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@var_CurveISP_VacParse:HAS[#key[Vac_LowPressure]]&@var_CurveISP_SLParse:HAS[~key[SL_LowPressure]]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
	{
		@MODULE[ModuleWaterfallFX],*
		{
			@TEMPLATE
			{
				@templateName = BetterRCS_LowVacPressure
			}
		}
	}
	
@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@var_CurveISP_VacParse:HAS[~key[Vac_LowPressure]]&@var_CurveISP_SLParse:HAS[#key[SL_LowPressure]]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
	{
		@MODULE[ModuleWaterfallFX],*
		{
			@TEMPLATE
			{
				@templateName = BetterRCS_LowSLPressure
			}
		}
	}
	
@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@var_CurveISP_VacParse:HAS[#key[Vac_LowPressure]]&@var_CurveISP_SLParse:HAS[#key[SL_LowPressure]]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
	{
		@MODULE[ModuleWaterfallFX],*
		{
			@TEMPLATE
			{
				@templateName = BetterRCS_LowVacSLPressure
			}
		}
	}
	
@PART[*]:HAS[@MODULE[ModuleRCSFX]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
    {
	@MODULE[ModuleRCSFX]
		{
			!var_CurveISP {}
			!var_CurveISP_SLParse {}
			!var_CurveISP_VacParse {}
		}	
	}
	
// OVERWRITE PASS - Special Fuel Types
// We're going to change the templates to a set of unique templates for various RCS thruster types based on their fuel use, like Xenon, or Methalox, or Hydrolox engines.

@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@PROPELLANT[LqdHydrogen]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
	{
		@MODULE[ModuleWaterfallFX],*
		{
			@TEMPLATE
			{
				@templateName = BetterRCS_Hydrolox
			}
		}
	}
	
	
@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@PROPELLANT[LqdMethane]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
	{
		@MODULE[ModuleWaterfallFX],*
		{
			@TEMPLATE
			{
				@templateName = BetterRCS_Methalox
			}
		}
	}