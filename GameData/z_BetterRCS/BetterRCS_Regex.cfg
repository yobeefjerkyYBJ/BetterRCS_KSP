@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[!PROPELLANT[ElectricCharge]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleRCSFX],*
	{
	+atmosphereCurve 
		{
			|. = var_CurveISP
			@key,* ^= :\s+: :
			@key,*[0, ] -= 0.1
			@key,*[0, ] ^= :^[^\d\.].*:1701.9: // Vacuum ISP confirmed
		}	
		
	@var_CurveISP:HAS[#key[*1701.9*]]
		{
			@key,*[0, ] -= 0.8
			@key,*[0, ] ^= :^[^\d\.].*:696969: // Evil ISP
		}
		
	@var_CurveISP:HAS[#key[*1701.1*]]
		{
			@key,*[0, ] -= 0.2
			@key,*[0, ] ^= :^[^\d\.].*:4421: // Sea Level ISP confirmed
		}
		+var_CurveISP
			{
				|. = var_CurveISP_VacParse
			}
		+var_CurveISP
			{
				|. = var_CurveISP_SLParse
			}
		
	@var_CurveISP_VacParse:HAS[#key[*1700.9*]]
		{
			@key,* ^= :1700\.9 ::
			@key,*[0, ] -= 245
			@key,* ^= :^[^\d\.].\S*\s*$:Vac_LowPressure: // If the Vacuum ISP is below 245, VacLP
		}
		
	@var_CurveISP_SLParse:HAS[#key[*4421*]]
		{
			@key,* ^= :4421 ::
			@key,*[0, ] -= 80
			@key,* ^= :^[^\d\.].\S*\s*$:SL_LowPressure: // If the Sea Level ISP is below 80, SLLP
		}
		
	}
}

// FIX PASS - Specific thrusters are sometimes very broken, like the Vernor, this is where they get their special care to actually function

@PART[vernierEngine]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	!MODULE[ModuleWaterfallFX],* {}
	MODULE
	{
	name = ModuleWaterfallFX
	moduleID = RCSVernierFX
		TEMPLATE
		{
			templateName = None
			overrideParentTransform = RCSthruster
			position = 0,-0.03,0
			rotation = 180,0,0
			scale = 1.3,1.3,1.3
		}
	}
}

@PART[RCSLinearSmall]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleWaterfallFX]
	{
		!TEMPLATE,1 {}
		@TEMPLATE,0
		{
			@position = 0,0,0
			@scale = 0.35,0.35,0.35
		}
	}
}

@PART[linearRcs]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleWaterfallFX]
	{
		!TEMPLATE,1 {}
		@TEMPLATE,0
		{
			@position = 0,-0.04,0
		}
	}
}

@PART[nesdIR-GM]:FOR[z_BetterRCS]:NEEDS[InternalRCS]
{
	@MODULE[ModuleWaterfallFX]
	{
		@TEMPLATE,0
		{
			@position = 0,-0.045,0
		}
	}
}

@PART[nesdIRmp*]:FOR[z_BetterRCS]:NEEDS[InternalRCS]
{
	@MODULE[ModuleWaterfallFX]
	{
		@TEMPLATE,0
		{
			@position = 0,-0.14,0
			@rotation = 180,0,0
			@scale = 1,1,1
		}
	}
}

@PART[nesdIRhl*]:FOR[z_BetterRCS]:NEEDS[InternalRCSPlus]
{
	@MODULE[ModuleWaterfallFX]
	{
		@TEMPLATE,0
		{
			@position = 0,-0.14,0
			@rotation = 180,0,0
			@scale = 1,1,1
		}
	}
}

@PART[nesdIRml*]:FOR[z_BetterRCS]:NEEDS[InternalRCSPlus]
{
	@MODULE[ModuleWaterfallFX]
	{
		@TEMPLATE,0
		{
			@position = 0,-0.14,0
			@rotation = 180,0,0
			@scale = 1,1,1
		}
	}
}

@PART[nesdIRmp1eng|nesdIRmp2eng|nesdIRmp3eng|nesdIRmp4eng|nesdIRmp5eng]:FOR[z_BetterRCS]:NEEDS[InternalRCS]
{
	@MODULE[ModuleWaterfallFX]
	{
		@TEMPLATE,0
		{
			position = 0,0,-0.15
			rotation = -90, 0, 0
			scale = 3, 3, 3
		}
	}
}


@PART[TE_18_DRAGONV2_POD|TE_18_DRAGONV2_POD_I4|TE_20_CargoRodan]:FOR[z_BetterRCS]:NEEDS[TundraExploration]
{

	@MODULE[ModuleWaterfallFX],1
	{
		@TEMPLATE
		{
			@position = 0,-0.03,0
			@rotation = 0,0,180
			@scale = 0.8,0.8,0.8
		}
	}
	@MODULE[ModuleWaterfallFX],2
	{
		@TEMPLATE
		{
			@position = 0,-0.03,0
			@rotation = 0,0,180
			@scale = 0.8,0.8,0.8
		}
	}
}

@PART[TE_21_DXL_Docking]:FOR[z_BetterRCS]:NEEDS[TundraExploration]
{
	@MODULE[ModuleWaterfallFX]
	{
		@TEMPLATE
		{
			@rotation = 180,0,0
		}
	}
}

@PART[TE_21_DXL_RCS]:FOR[z_BetterRCS]:NEEDS[TundraExploration]
{
	@MODULE[ModuleWaterfallFX]
	{
		@TEMPLATE
		{
			@position = 0,-0.07,0
			@rotation = 180,0,0
		}
	}
}

@PART[TE2_19_F9_CGT]:FOR[z_BetterRCS]:NEEDS[TundraExploration]
{
	@MODULE[ModuleWaterfallFX]
	{
		!EFFECT {}
		TEMPLATE
		{
			templateName = None
			overrideParentTransform = RCS
			position = 0,0,0
			rotation = 180,0,0
			scale = 0.6,0.6,0.6
		}
	}
}

// POSTFIX PASS - This runs AFTER everything else, but is placed before SCALE and ALLOCATION for ease of reading, this is for special cases where BetterRCS accidentally replaces a plume that shouldn't be replaced

@PART[TE_18_DRAGONV2_POD|TE_18_DRAGONV2_POD_I4|TE_20_CargoRodan]:AFTER[z_BetterRCS]:NEEDS[TundraExploration]
{
	@MODULE[ModuleWaterfallFX],0
	{
		!CONTROLLER,1 {}
		CONTROLLER
		{
			name = throttle
			linkedTo = throttle
		}
		@TEMPLATE
		{
			@templateName = superDracoTemplate
		}
	}
}

// SCALE PASS - Fix scaling issues with some parts that would otherwise make the plumes look really bad
// This has to go after the FIX PASS because some fixes require the whole ModuleWaterfallFX module be torn down

@PART[*]:HAS[@MODULE[ModuleWaterfallFX],@MODULE[ModuleRCSFX]:HAS[@var_CurveISP]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleWaterfallFX]:HAS[@CONTROLLER[rcs]],*
	{
		&CONTROLLER
		{
			name = atmosphereDepth
			linkedTo = atmosphere_density
		}
		@TEMPLATE
		{
			scaleX = #$scale$
			@scaleX ^= :,.*$::
			@scale[1,,] = #$scaleX$
			!scaleX = dummy
		}
	}
}

// ALLOCATION PASS - This is where the patch's applied dark arts comes into play and gives every RCS thruster a specified plume depending on ISP.

//We are checking against the four cases provided by the earlier regex tomfoolery
//Namely, Base, Low Vacuum Pressure, Low Sea Level Pressure, and Low Universal Pressure
//These are as follows:
//Base - BetterRCS_Base
//Low Vacuum Pressure - BetterRCS_LowVacPressure
//Low Sea Level Pressure - BetterRCS_LowSLPressure
//Low Universal Pressure - BetterRCS_LowVacSLPressure

@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@var_CurveISP_VacParse:HAS[~key[Vac_LowPressure]]&@var_CurveISP_SLParse:HAS[~key[SL_LowPressure]]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleWaterfallFX]:HAS[@CONTROLLER[rcs]],*
	{
		@TEMPLATE
		{
			@templateName = BetterRCS_Base
		}
	}
}

@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@var_CurveISP_VacParse:HAS[#key[Vac_LowPressure]]&@var_CurveISP_SLParse:HAS[~key[SL_LowPressure]]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleWaterfallFX]:HAS[@CONTROLLER[rcs]],*
	{
		@TEMPLATE
		{
			@templateName = BetterRCS_LowVacPressure
		}
	}
}

@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@var_CurveISP_VacParse:HAS[~key[Vac_LowPressure]]&@var_CurveISP_SLParse:HAS[#key[SL_LowPressure]]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleWaterfallFX]:HAS[@CONTROLLER[rcs]],*
	{
		@TEMPLATE
		{
			@templateName = BetterRCS_LowSLPressure
		}
	}
}

@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@var_CurveISP_VacParse:HAS[#key[Vac_LowPressure]]&@var_CurveISP_SLParse:HAS[#key[SL_LowPressure]]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleWaterfallFX]:HAS[@CONTROLLER[rcs]],*
	{
		@TEMPLATE
		{
			@templateName = BetterRCS_LowVacSLPressure
		}
	}
}

@PART[*]:HAS[@MODULE[ModuleRCSFX]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleRCSFX],*
	{
		!var_CurveISP {}
		!var_CurveISP_SLParse {}
		!var_CurveISP_VacParse {}
	}	
}

// OVERWRITE PASS - Special Fuel Types
// We're going to change the templates to a set of unique templates for various RCS thruster types based on their fuel use, like Xenon, or Methalox, or Hydrolox engines.

@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@PROPELLANT[LqdHydrogen]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleWaterfallFX]:HAS[@CONTROLLER[rcs]],*
	{
		@TEMPLATE
		{
			@templateName = BetterRCS_Hydrolox
		}
	}
}


@PART[*]:HAS[@MODULE[ModuleRCSFX]:HAS[@PROPELLANT[LqdMethane]]]:FOR[z_BetterRCS]:NEEDS[Waterfall]
{
	@MODULE[ModuleWaterfallFX]:HAS[@CONTROLLER[rcs]],*
	{
		@TEMPLATE
		{
			@templateName = BetterRCS_Methalox
		}
	}
}